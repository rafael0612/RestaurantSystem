@page "/cocina/kds"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Cocinero,Admin")]
@implements IDisposable

@inject RestaurantSystem.Client.Services.CocinaApi CocinaApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudStack Spacing="2">

    <!-- Header -->
    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <MudText Typo="Typo.h5">Cocina (KDS)</MudText>

        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="@(() => Reload(false))">
            Actualizar
        </MudButton>
    </MudStack>

    <!-- Filtro por estado + Auto refresh -->
    <MudPaper Class="pa-3">
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle2">Filtro por estado</MudText>

            <!-- ChipSet tipado -->
            <MudChipSet T="EstadoCocinaItem?"
                        Filter="true"
                        SelectedValue="@_estadoFiltro"
                        SelectedValueChanged="OnFiltroChanged"
                        Mandatory="false"
                        Class="d-flex flex-wrap">

                <MudChip T="EstadoCocinaItem?" Value="@((EstadoCocinaItem?)null)" Variant="Variant.Outlined">Todos</MudChip>
                <MudChip T="EstadoCocinaItem?" Value="@EstadoCocinaItem.Pendiente" Variant="Variant.Outlined">Pendiente</MudChip>
                <MudChip T="EstadoCocinaItem?" Value="@EstadoCocinaItem.Preparando" Variant="Variant.Outlined">Preparando</MudChip>
                <MudChip T="EstadoCocinaItem?" Value="@EstadoCocinaItem.Listo" Variant="Variant.Outlined">Listo</MudChip>
            </MudChipSet>

            <MudDivider />

            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Style="flex-wrap:wrap">
                <!-- ✅ BIND directo para que refresque la UI SIEMPRE -->
                <MudSwitch T="bool"
                           @bind-Value="OnlyUrgent"
                           Color="Color.Warning"
                           Label="Solo mis pendientes" />

                <MudSwitch T="bool"
                           @bind-Value="AutoRefresh"
                           Color="Color.Primary"
                           Label="Auto refresh" />

                <MudSelect T="int"
                           Dense="true"
                           Label="Segundos"
                           @bind-Value="RefreshSeconds"
                           Disabled="@(!AutoRefresh)"
                           Style="min-width:160px">
                    <MudSelectItem T="int" Value="5">5</MudSelectItem>
                    <MudSelectItem T="int" Value="10">10</MudSelectItem>
                    <MudSelectItem T="int" Value="15">15</MudSelectItem>
                    <MudSelectItem T="int" Value="20">20</MudSelectItem>
                </MudSelect>

                <MudSpacer />

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @(_lastUpdated is null ? "" : $"Última actualización: {_lastUpdated:HH:mm:ss}")
                </MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (CardsToRender().Count == 0)
    {
        <MudAlert Severity="Severity.Info">No hay comandas para mostrar con el filtro actual.</MudAlert>
    }
    else
    {
        <MudGrid Spacing="2">
            @foreach (var card in CardsToRender())
            {
                <MudItem xs="12" sm="6" md="4" @key="card.ComandaId">
                    <MudCard Class="pa-2">
                        <MudCardContent>
                            <MudStack Spacing="1">

                                <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <MudText Typo="Typo.h6">@card.Origen</MudText>
                                    <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">
                                        @card.Estado.ToString()
                                    </MudChip>
                                </MudStack>

                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @card.CreadaEn.ToLocalTime().ToString("HH:mm:ss") · @FormatAge(card.CreadaEn)
                                </MudText>

                                <!-- Badges por card -->
                                @{
                                    var cPend = card.Items.Count(i => i.Estado == EstadoCocinaItem.Pendiente);
                                    var cPrep = card.Items.Count(i => i.Estado == EstadoCocinaItem.Preparando);
                                    var cList = card.Items.Count(i => i.Estado == EstadoCocinaItem.Listo);

                                    Variant vPend = cPend > 0 ? Variant.Filled : Variant.Outlined;
                                    Variant vPrep = cPrep > 0 ? Variant.Filled : Variant.Outlined;
                                    Variant vList = cList > 0 ? Variant.Filled : Variant.Outlined;
                                }

                                <MudStack Row="true" Spacing="1" Style="flex-wrap:wrap" Class="mt-1">
                                    <MudChip T="string" Size="Size.Small" Variant="@vPend" Color="Color.Warning">Pend @cPend</MudChip>
                                    <MudChip T="string" Size="Size.Small" Variant="@vPrep" Color="Color.Info">Prep @cPrep</MudChip>
                                    <MudChip T="string" Size="Size.Small" Variant="@vList" Color="Color.Success">Listo @cList</MudChip>
                                </MudStack>

                                <MudDivider Class="my-2" />

                                @{
                                    // ✅ ESTE es el filtrado real que ahora sí se renderiza
                                    var items = ItemsFiltrados(card.Items);
                                }

                                @if (items.Count == 0)
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Sin ítems para este filtro.</MudText>
                                }
                                else
                                {
                                    <MudStack Spacing="2">
                                        @foreach (var it in items.OrderBy(i => i.Estado).ThenBy(i => i.Producto))
                                        {
                                            <MudPaper Class="pa-2 mb-2" Elevation="0" Style="border:1px solid rgba(0,0,0,.08); border-radius:12px;"
                                                      @key="it.ComandaDetalleId">
                                                <MudStack Spacing="1">

                                                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <MudText Typo="Typo.subtitle1">@it.Producto</MudText>

                                                        <MudChip T="string"
                                                                 Variant="Variant.Filled"
                                                                 Color="@ChipColor(it.Estado)"
                                                                 Size="Size.Small">
                                                            @it.Estado.ToString()
                                                        </MudChip>
                                                    </MudStack>

                                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Style="flex-wrap:wrap">
                                                        <MudText Typo="Typo.body2"><b>@it.Cantidad</b></MudText>

                                                        @if (!string.IsNullOrWhiteSpace(it.Observacion))
                                                        {
                                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                                • @it.Observacion
                                                            </MudText>
                                                        }
                                                    </MudStack>

                                                    <MudGrid Spacing="1" Class="mt-2">
                                                        <MudItem xs="12" sm="6">
                                                            <MudButton FullWidth="true"
                                                                       Size="Size.Large"
                                                                       Variant="Variant.Filled"
                                                                       Color="Color.Info"
                                                                       Disabled="@(_busyItemId == it.ComandaDetalleId || it.Estado != EstadoCocinaItem.Pendiente)"
                                                                       OnClick="@(() => CambiarEstado(it.ComandaDetalleId, EstadoCocinaItem.Preparando))">
                                                                Preparando
                                                            </MudButton>
                                                        </MudItem>

                                                        <MudItem xs="12" sm="6">
                                                            <MudButton FullWidth="true"
                                                                       Size="Size.Large"
                                                                       Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Disabled="@(_busyItemId == it.ComandaDetalleId || it.Estado != EstadoCocinaItem.Preparando)"
                                                                       OnClick="@(() => ConfirmarYMarcarListo(it))">
                                                                Listo
                                                            </MudButton>
                                                        </MudItem>
                                                    </MudGrid>

                                                </MudStack>
                                            </MudPaper>
                                        }
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    private bool _loading;
    private List<KdsCardDto> _cards = new();

    private EstadoCocinaItem? _estadoFiltro = null;

    private bool _autoRefresh = false;
    private bool _onlyUrgent = false;
    private int _refreshSeconds = 10;

    private DateTime? _lastUpdated;
    private Guid? _busyItemId;

    private CancellationTokenSource? _loopCts;
    private readonly SemaphoreSlim _reloadLock = new(1, 1);

    protected override async Task OnInitializedAsync()
    {
        await Reload(false);
    }

    public void Dispose()
    {
        StopLoop();
        _reloadLock.Dispose();
    }

    private async Task OnFiltroChanged(EstadoCocinaItem? value)
    {
        _estadoFiltro = value;
        await Reload(false);
    }

    // ✅ Propiedades con efecto (bind-friendly)
    private bool AutoRefresh
    {
        get => _autoRefresh;
        set
        {
            if (_autoRefresh == value) return;
            _autoRefresh = value;

            if (_autoRefresh)
            {
                StartLoop();
                _ = Reload(true);
            }
            else
            {
                StopLoop();
            }
        }
    }

    private int RefreshSeconds
    {
        get => _refreshSeconds;
        set
        {
            if (_refreshSeconds == value) return;
            _refreshSeconds = value;

            if (_autoRefresh)
            {
                StopLoop();
                StartLoop();
            }
        }
    }

    private bool OnlyUrgent
    {
        get => _onlyUrgent;
        set
        {
            if (value == true)
            {
                var estado = EstadoCocinaItem.Pendiente;
                _estadoFiltro = estado;
            }
            else _estadoFiltro = null;

            if (_onlyUrgent == value) return;
            _onlyUrgent = value;

            // No necesito pegarle a la API para esto; es un filtro local
            InvokeAsync(StateHasChanged);
        }
    }
    private bool _AllPedido()
    {
        _estadoFiltro = null;
        return _onlyUrgent;
    }

    private void StartLoop()
    {
        StopLoop();
        _loopCts = new CancellationTokenSource();
        _ = Task.Run(() => AutoLoopAsync(_loopCts.Token));
    }

    private void StopLoop()
    {
        try { _loopCts?.Cancel(); } catch { }
        _loopCts?.Dispose();
        _loopCts = null;
    }

    private async Task AutoLoopAsync(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            try
            {
                await Task.Delay(TimeSpan.FromSeconds(_refreshSeconds), token);
            }
            catch (TaskCanceledException) { break; }

            await InvokeAsync(async () => await Reload(true));
        }
    }

    private async Task Reload(bool silent)
    {
        if (!await _reloadLock.WaitAsync(0))
            return;

        try
        {
            if (!silent) _loading = true;

            _cards = await CocinaApi.GetKdsAsync(_estadoFiltro);
            _lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            if (!silent) _loading = false;
            _reloadLock.Release();
            StateHasChanged();
        }
    }

    private List<KdsCardDto> CardsToRender()
    {
        IEnumerable<KdsCardDto> q = _cards;

        if (_onlyUrgent)
        {
            // Urgente: cards que tengan Pendiente o Preparando
            q = q.Where(c => c.Items.Any(i =>
                i.Estado == EstadoCocinaItem.Pendiente ||
                i.Estado == EstadoCocinaItem.Preparando));

            // Orden: más pendientes primero, luego preparando, luego antigüedad
            q = q
                .OrderByDescending(c => c.Items.Count(i => i.Estado == EstadoCocinaItem.Pendiente))
                .ThenByDescending(c => c.Items.Count(i => i.Estado == EstadoCocinaItem.Preparando))
                .ThenBy(c => c.CreadaEn);
        }
        else
        {
            q = q.OrderBy(c => c.Estado);
        }

        return q.ToList();
    }

    private List<KdsItemDto> ItemsFiltrados(List<KdsItemDto> items)
    {
        var result = items;

        if (_estadoFiltro is not null)
            result = result.Where(i => i.Estado == _estadoFiltro.Value).ToList();

        if (_onlyUrgent)
            result = result.Where(i => i.Estado == EstadoCocinaItem.Pendiente || i.Estado == EstadoCocinaItem.Preparando).ToList();

        return result;
    }

    private async Task CambiarEstado(Guid detalleId, EstadoCocinaItem nuevoEstado)
    {
        _busyItemId = detalleId;
        try
        {
            await CocinaApi.CambiarEstadoItemAsync(detalleId, nuevoEstado);
            await Reload(true);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _busyItemId = null;
        }
    }

    private async Task ConfirmarYMarcarListo(KdsItemDto it)
    {
        var ok = await DialogService.ShowMessageBox(
            title: "Confirmar",
            markupMessage: (MarkupString)$"¿Marcar <b>{it.Producto}</b> como <b>Listo</b>?",
            yesText: "Sí, listo",
            cancelText: "Cancelar");

        if (ok != true) return;

        await CambiarEstado(it.ComandaDetalleId, EstadoCocinaItem.Listo);
    }

    private static Color ChipColor(EstadoCocinaItem estado) => estado switch
    {
        EstadoCocinaItem.Pendiente => Color.Warning,
        EstadoCocinaItem.Preparando => Color.Info,
        EstadoCocinaItem.Listo => Color.Success,
        EstadoCocinaItem.Entregado => Color.Default,
        EstadoCocinaItem.Anulado => Color.Error,
        _ => Color.Default
    };

    private static string FormatAge(DateTime creadaEnUtc)
    {
        var age = DateTime.UtcNow - creadaEnUtc;
        if (age.TotalMinutes < 1) return "Hace segundos";
        if (age.TotalMinutes < 60) return $"Hace {Math.Floor(age.TotalMinutes)} min";
        return $"Hace {Math.Floor(age.TotalHours)} h";
    }
}
